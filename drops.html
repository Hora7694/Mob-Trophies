<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Mob Trophies - Drops</title>
    <style>
        .search-container { position: relative; width: 100%; margin-bottom: 20px; }
        .info-icon {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            background: var(--border-color); color: var(--text-muted);
            width: 20px; height: 20px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold; cursor: help; transition: 0.3s;
            border: 1px solid var(--border-color);
        }
        .info-icon:hover { color: var(--accent); border-color: var(--accent); }
        .tooltip {
            visibility: hidden; position: absolute; right: 0; top: 100%;
            background: #1a222b; color: var(--text-main); padding: 12px 15px;
            border-radius: 8px; border: 1px solid var(--accent); width: 320px;
            font-size: 0.8rem; z-index: 10; margin-top: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); opacity: 0; transition: opacity 0.3s;
        }
        .info-icon:hover + .tooltip { visibility: visible; opacity: 1; }
        .tooltip b { color: var(--accent); }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">Home</a>
        <a href="drops.html" class="active">Drops</a>
        <a href="download.html">Download</a>
    </nav>

    <div class="container">
        <h1 class="accent-text">Drops list</h1>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search a mob or use filters..." 
                   style="width: 100%; padding: 15px 45px 15px 15px; border-radius: 8px; background: #12181f; border: 1px solid #2d3748; color: white; box-sizing: border-box;">
            
            <div class="info-icon">?</div>
            <div class="tooltip">
                <b>Search tips:</b><br>
                • <b>z:[zone number]</b> : Filter by zone.<br>
                • <b>r:[rarity]</b> : Filter by rarity.<br>
                <small style="opacity: 0.6;">Rarity: uncommon, rare, epic, mythic, legendary</small><br>
                • <b>t:[type]</b> Filter by type.<br>
            </div>
        </div>
        
        <div id="mobsGrid"></div>
    </div>

    <button id="backToTop" title="Back to top">
        <img src="img/ui/arrow-up.png" alt="Top" style="width: 20px; height: 20px;">
    </button>

    <footer>
      <div class="footer-content">
          <div id="kofi-widget">
            <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script>
            <script type='text/javascript'>
                kofiwidget2.init('Support me on Ko-fi', '#d63767', 'T6T117BAZT');kofiwidget2.draw();
            </script> 
          </div>

          <div class="footer-links">
              <a href="index.html">Home</a>
              <a href="drops.html">Drops</a>
              <a href="download.html">Download</a>
              <a href="legal.html">Terms of Service</a>
          </div>

          <div class="copyright">
              &copy; 2026 Mob Trophies (by kHorah_) - All rights reserved.
          </div>
          <div class="text-xs opacity-30 text-center" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 10px;">
              This site is a fan project not affiliated with Hypixel Studios or Hytale.
          </div>
      </div>
    </footer>

    <script>
        const btnTop = document.getElementById("backToTop");
        const rarityColors = {
            "uncommon": "var(--rarity-uncommon)",
            "rare": "var(--rarity-rare)",
            "epic": "var(--rarity-epic)",
            "mythic": "var(--rarity-mythic)",
            "legendary": "var(--rarity-legendary)"
        };

        // Gestion des images (simples ou animées)
        const renderMedia = (mediaData, name) => {
            const isArray = Array.isArray(mediaData);
            const firstImg = isArray ? mediaData[0] : (mediaData || 'img/placeholder.png');
            if (isArray && mediaData.length > 1) {
                return `<img src="${firstImg}" class="cycling-img" data-sources='${JSON.stringify(mediaData)}' data-index="0" alt="${name}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            }
            return `<img src="${firstImg}" alt="${name}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
        };

        // Fonction de rendu principale
        const render = (list, grid, searchTerms = []) => {
            const rarityFilter = searchTerms.find(t => t.startsWith('r:'))?.split('r:')[1];
            const typeFilter = searchTerms.find(t => t.startsWith('t:'))?.split('t:')[1];

            grid.innerHTML = list.map(m => {
                let dropItems = m.drops ? Object.values(m.drops) : [];
                if (rarityFilter || typeFilter) {
                    dropItems = dropItems.filter(item => {
                        const matchRarity = rarityFilter ? (item.rarity && item.rarity.toLowerCase() === rarityFilter) : true;
                        const matchType = typeFilter ? (item.type && item.type.toLowerCase() === typeFilter) : true;
                        return matchRarity && matchType;
                    });
                }
                if ((rarityFilter || typeFilter) && dropItems.length === 0) return '';

                return `
                    <div class="card" style="display: flex; align-items: center; gap: 30px;">
                        <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden;">
                            ${renderMedia(m.image, m.name)}
                        </div>
                        <div style="flex-grow: 1;">
                            <h3 style="margin: 0; font-size: 1.4rem; color: #fff;">${m.name}</h3>
                            <p style="font-size: 0.75rem; opacity: 0.5; margin: 4px 0 15px 0; font-family: monospace;">Zone: ${m.zone}</p>
                            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                ${dropItems.map(item => {
                                    const color = rarityColors[item.rarity?.toLowerCase()] || "var(--rarity-default)";
                                    const textId = `drop-${Math.random().toString(36).substr(2, 9)}`;
                                    return `
                                        <div class="item-card" style="background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.2) 100%); border: 1px solid ${color}; padding: 10px 14px; border-radius: 8px; display: flex; align-items: center; gap: 12px; min-width: 190px; position: relative;">
                                            <div style="position: absolute; top: 5px; right: 8px; font-size: 0.55rem; opacity: 0.4; color: #fff;">${item.addedVersion || 'v0.1'}</div>
                                            <div style="width: 32px; height: 32px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: hidden;">${renderMedia(item.img, item.name)}</div>
                                            <div>
                                                <div style="font-size: 0.85rem; font-weight: bold; color: var(--text-main);">${item.name}</div>
                                                <div style="font-size: 0.75rem;"><span style="color: var(--text-muted);">${item.drops}%</span> <span style="color: ${color}; font-size: 0.65rem;">${item.rarity}</span></div>
                                            </div>
                                        </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>`;
            }).join('');
        };

        // Chargement des données
        async function load() {
            try {
                const res = await fetch('mobs.json');
                const data = await res.json();
                const grid = document.getElementById('mobsGrid');

                render(data, grid);

                // Event Listeners (Scroll & Recherche)
                window.addEventListener('scroll', () => {
                    btnTop.style.display = window.scrollY > 400 ? "flex" : "none";
                });

                btnTop.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                document.getElementById('searchInput').addEventListener('input', e => {
                    const terms = e.target.value.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
                    const filtered = terms.length === 0 ? data : data.filter(m => 
                        terms.every(term => {
                            if (term.startsWith('z:')) return m.zone.toString() === term.split('z:')[1];
                            if (term.startsWith('r:')) return Object.values(m.drops || {}).some(i => i.rarity?.toLowerCase() === term.split('r:')[1]);
                            return m.name.toLowerCase().includes(term);
                        })
                    );
                    render(filtered, grid, terms);
                });

                // Animation images
                setInterval(() => {
                    document.querySelectorAll('.cycling-img').forEach(img => {
                        const sources = JSON.parse(img.dataset.sources);
                        let idx = (parseInt(img.dataset.index) + 1) % sources.length;
                        img.src = sources[idx];
                        img.dataset.index = idx;
                    });
                }, 2000);

            } catch (err) { console.error("Erreur de chargement:", err); }
        }
        load();
    </script>
</body>
</html>