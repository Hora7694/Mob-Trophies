<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <title>Mob Trophies - Drops</title>
</head>
<body>
    <nav>
        <a href="index.html">Home</a>
        <a href="drops.html" class="active">Drops</a>
        <a href="download.html">Download</a>
        <a href="support.html">Support</a>
    </nav>

    <div class="container">
        <h1 class="accent-text">Drops list</h1>
        
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search a mob or use filters..." 
                   style="width: 100%; padding: 15px 45px 15px 15px; border-radius: 8px; background: #12181f; border: 1px solid #2d3748; color: white; box-sizing: border-box;">
            
            <div class="info-icon">?</div>
            <div class="tooltip">
                <b>Search tips:</b><br>
                • <b>z:[zone number]</b> : Filter by zone.<br>
                • <b>r:[rarity]</b> : Filter by rarity.<br>
                <small style="opacity: 0.6;">Rarity: uncommon, rare, epic, mythic, legendary</small><br>
                • <b>t:[type]</b> : Filter by type.<br>
                <small style="opacity: 0.6;">Type: statue, head, fragment</small><br>
            </div>
        </div>
        
        <div id="mobsGrid"></div>
    </div>

    <button id="backToTop" title="Back to top">
        <img src="img/icons/UI/Arrow_Up_Icon.png" alt="Top" style="width: 20px; height: 20px;">
    </button>

    <footer>
      <div class="footer-content">
          <script type='text/javascript' src='https://storage.ko-fi.com/cdn/widget/Widget_2.js'></script>
          <script type='text/javascript'>
              kofiwidget2.init('Support me on Ko-fi', '#d4af37', 'T6T117BAZT');kofiwidget2.draw();
          </script> 

          <div class="footer-links">
              <a href="index.html">Home</a>
              <a href="drops.html">Drops</a>
              <a href="download.html">Download</a>
              <a href="support.html">Support</a>
              <a href="legal.html">Terms of Service</a>
          </div>

          <div class="copyright">
              &copy; 2026 Mob Trophies (by kHorah_) - All rights reserved.
          </div>
          <div class="text-xs opacity-30 text-center" style="font-size: 0.7rem; color: var(--text-muted); margin-top: 10px;">
              This site is a fan project not affiliated with Hypixel Studios or Hytale.
          </div>
      </div>
    </footer>

    <script>
            const btnTop = document.getElementById("backToTop");
            const rarityColors = {
                "uncommon": "var(--rarity-uncommon)",
                "rare": "var(--rarity-rare)",
                "epic": "var(--rarity-epic)",
                "mythic": "var(--rarity-mythic)",
                "legendary": "var(--rarity-legendary)"
            };

            // Variable de configuration pour les zones
            const TOTAL_ZONES_COUNT = 4; 

            // --- Gestion du bouton Back to Top ---
            window.addEventListener('scroll', () => {
                btnTop.style.display = window.pageYOffset > 400 ? "flex" : "none";
            });

            btnTop.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // --- Rendu des médias (images simples ou cycliques) ---
            const renderMedia = (mediaData, name) => {
                const isArray = Array.isArray(mediaData);
                const firstImg = isArray ? mediaData[0] : (mediaData || 'img/placeholder.png');
                if (isArray && mediaData.length > 1) {
                    return `<img src="${firstImg}" class="cycling-img" data-sources='${JSON.stringify(mediaData)}' data-index="0" alt="${name}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
                }
                return `<img src="${firstImg}" alt="${name}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
            };

            // --- Fonction pour formater l'affichage des zones ---
            const formatZoneDisplay = (zoneData) => {
                const zones = Array.isArray(zoneData) ? zoneData : [zoneData];
                if (zones.length >= TOTAL_ZONES_COUNT) return "Any";
                return zones.join(', ');
            };

            // --- Fonction de rendu principale ---
            const render = (list, grid, searchTerms = []) => {
                const rarityFilter = searchTerms.find(t => t.startsWith('r:'))?.split('r:')[1];
                const typeFilter = searchTerms.find(t => t.startsWith('t:'))?.split('t:')[1];

                grid.innerHTML = list.map(m => {
                    let dropItems = m.drops ? Object.values(m.drops) : [];
                    
                    // Filtrage des items par rareté ou type
                    if (rarityFilter || typeFilter) {
                        dropItems = dropItems.filter(item => {
                            const matchRarity = rarityFilter ? (item.rarity && item.rarity.toLowerCase() === rarityFilter) : true;
                            const matchType = typeFilter ? (item.type && item.type.toLowerCase() === typeFilter) : true;
                            return matchRarity && matchType;
                        });
                    }
                    
                    if ((rarityFilter || typeFilter) && dropItems.length === 0) return '';

                    return `
                        <div class="card" style="display: flex; align-items: center; gap: 30px;">
                            <div style="background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden;">
                                ${renderMedia(m.image, m.name)}
                            </div>
                            <div style="flex-grow: 1;">
                                <h3 style="margin: 0; font-size: 1.4rem; color: #fff;">${m.name}</h3>
                                <p style="font-size: 0.75rem; opacity: 0.5; margin: 4px 0 15px 0; font-family: monospace;">
                                    Zone: ${formatZoneDisplay(m.zone)}
                                </p>
                                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    ${dropItems.map(item => {
                                        const color = rarityColors[item.rarity?.toLowerCase()] || "var(--rarity-default)";
                                        const hasHover = !!item.dropsHover;
                                        
                                        return `
                                            <div class="item-card ${hasHover ? 'has-hover' : ''}" style="background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0.2) 100%); border: 1px solid ${color}; padding: 12px 14px; border-radius: 8px; display: flex; align-items: center; gap: 12px; min-width: 200px; position: relative;">
                                                <div style="position: absolute; top: 6px; right: 8px; font-size: 0.55rem; opacity: 0.5; color: #fff; font-family: monospace;">${item.addedVersion || 'v0.1'}</div>
                                                <div style="width: 32px; height: 32px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; overflow: hidden;">${renderMedia(item.img, item.name)}</div>
                                                <div style="padding-right: 30px;">
                                                    <div style="font-size: 0.85rem; font-weight: bold; color: var(--text-main); line-height: 1.2;">${item.name}</div>
                                                    <div style="font-size: 0.75rem; margin-top: 2px;">
                                                        <span class="drop-value" style="color: var(--text-muted);">${item.drops}%</span>
                                                        ${hasHover ? `<span class="drop-hover-text">${item.dropsHover}</span>` : ''}
                                                        <span style="color: ${color}; font-size: 0.65rem; text-transform: uppercase; font-weight: bold; margin-left: 4px;">${item.rarity}</span>
                                                    </div>
                                                </div>
                                            </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>`;
                }).join('');
            };

            // --- Chargement des données et Recherche ---
            async function load() {
                try {
                    const res = await fetch('mobs.json');
                    const data = await res.json();
                    const grid = document.getElementById('mobsGrid');
                    render(data, grid);

                    document.getElementById('searchInput').addEventListener('input', e => {
                        const terms = e.target.value.toLowerCase().trim().split(/\s+/).filter(t => t.length > 0);
                        const filtered = data.filter(m => 
                            terms.every(term => {
                                // Filtre Zone (gère les nombres et les tableaux)
                                if (term.startsWith('z:')) {
                                    const targetZone = term.split('z:')[1];
                                    const mobZones = Array.isArray(m.zone) ? m.zone.map(String) : [m.zone.toString()];
                                    return mobZones.includes(targetZone);
                                }
                                // Filtres Rareté et Type
                                if (term.startsWith('r:')) return Object.values(m.drops || {}).some(i => i.rarity?.toLowerCase() === term.split('r:')[1]);
                                if (term.startsWith('t:')) return Object.values(m.drops || {}).some(i => i.type?.toLowerCase() === term.split('t:')[1]);
                                // Recherche Nom
                                return m.name.toLowerCase().includes(term);
                            })
                        );
                        render(filtered, grid, terms);
                    });

                    // Intervalle pour les images cycliques
                    setInterval(() => {
                        document.querySelectorAll('.cycling-img').forEach(img => {
                            const sources = JSON.parse(img.dataset.sources);
                            let idx = (parseInt(img.dataset.index) + 1) % sources.length;
                            img.src = sources[idx];
                            img.dataset.index = idx;
                        });
                    }, 2000);

                } catch (err) { console.error(err); }
            }
            load();
        </script>
</body>
</html>